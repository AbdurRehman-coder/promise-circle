name: Flutter CI - Build AAB + IPA

on:
  push:
    branches:
      - stage
  workflow_dispatch:

jobs:
  notify:
   runs-on: ubuntu-latest
   steps:
     - name: Notify Discord - build started
       if: ${{ github.event_name != 'workflow_dispatch' || always() }}
       env:
         DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
       run: |
         if [ -n "$DISCORD_WEBHOOK_URL" ]; then
           BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-${GITHUB_REF}}}"
           ARTIFACTS_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/artifacts"
           payload=$(
             jq -n \
               --arg title "üì¶ Build started (AAB + IPA)" \
               --arg app "Promise Circles" \
               --arg branch "$BRANCH_NAME" \
               --arg run "${GITHUB_RUN_NUMBER}" \
               --arg status "Started" \
               --arg artifacts "$ARTIFACTS_URL" \
               --arg workflow "$GITHUB_WORKFLOW" \
               --arg repo "$GITHUB_REPOSITORY" \
               --argjson color 15844367 \
               '{
                 embeds: [
                   {
                     title: $title,
                     color: $color,
                     fields: [
                       { "name": "App",       "value": $app,       "inline": true },
                       { "name": "Branch",    "value": $branch,    "inline": true },
                       { "name": "Run",       "value": $run,       "inline": true },
                       { "name": "Status",    "value": $status,    "inline": true },
                       { "name": "Artifacts", "value": $artifacts, "inline": false }
                     ],
                     footer: { "text": ("Workflow: " + $workflow + " ‚Ä¢ Repo: " + $repo) }
                   }
                 ]
               }'
           )
           curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
         fi

  build-android:
    runs-on: ubuntu-latest
    needs: notify
    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Java 17
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3Ô∏è‚É£ Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.3"
          channel: "stable"

      # 4Ô∏è‚É£ Cache Flutter dependencies
      - name: Cache Flutter Pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: flutter-pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 34
          build-tools: 34.0.0
          cmake: 3.22.1

      # 5Ô∏è‚É£ Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # 7Ô∏è‚É£ Cache Android SDK
      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.android
            /usr/local/lib/android/sdk
          key: android-sdk-${{ runner.os }}

      # 8Ô∏è‚É£ Setup keystore & environment
      - name: Create .env and keystore
        run: |
          cat > .env << EOF
          ENVIRONMENT=stage
          API_URL_PROD=${{ secrets.API_URL_PROD }}
          API_URL_TEST=${{ secrets.API_URL_TEST }}
          IOS_CLIENT_ID=${{ secrets.IOS_CLIENT_ID }}
          SERVER_CLIENT_ID=${{ secrets.SERVER_CLIENT_ID }}
          WEB_CLIENT_ID=${{ secrets.SERVER_CLIENT_ID }}
          WEB_CLIENT_ID_DEBUG=${{ secrets.WEB_CLIENT_ID_DEBUG }}
          EOF
  
          mkdir -p android/app/keystores
          echo "${{ secrets.KEYSTORE_FILE_BASE64 }}" | base64 -d > android/app/keystores/upload-promise_circle.jks
  
          cat > android/key.properties << EOF
          storeFile=keystores/promise_circle.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      # 9Ô∏è‚É£ Fetch Flutter dependencies
      - name: Flutter pub get
        run: flutter pub get

      # üîü Build AAB
      - name: Build Android AAB
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx1g"
        run: flutter build appbundle

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload to Play Store Internal
      - name: Upload to Play Store (Internal)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.promisecircles.app
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed

  build-ios:
    runs-on: macos-26  # iOS 26 SDK (Xcode 26) required for App Store from April 2026; includes SwiftSupport for GM builds
    needs: notify

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 1b Use Xcode 26 (iOS 26 SDK) ‚Äì required for App Store / TestFlight; SwiftSupport included with app-store export
      - name: Select Xcode 26
        run: |
          if [ -d /Applications/Xcode_26.2.app ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.app
          fi
          xcodebuild -version
          xcrun simctl list runtimes 2>/dev/null | head -5 || true

      # 2Ô∏è‚É£ Setup Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.3"
          channel: "stable"

      # 2b Install FlutterFire CLI (required by Xcode Run Script for Crashlytics symbols)
      - name: Install FlutterFire CLI
        run: dart pub global activate flutterfire_cli

      # 3Ô∏è‚É£ Env file
      - name: Create .env
        run: |
          cat > .env << EOF
          ENVIRONMENT=stage
          API_URL_PROD=${{ secrets.API_URL_PROD }}
          API_URL_TEST=${{ secrets.API_URL_TEST }}
          IOS_CLIENT_ID=${{ secrets.IOS_CLIENT_ID }}
          SERVER_CLIENT_ID=${{ secrets.SERVER_CLIENT_ID }}
          WEB_CLIENT_ID=${{ secrets.SERVER_CLIENT_ID }}
          WEB_CLIENT_ID_DEBUG=${{ secrets.WEB_CLIENT_ID_DEBUG }}
          EOF

      # 4Ô∏è‚É£ Install Apple Distribution Certificate
      - name: Install iOS Certificate
        env:
          P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$P12_BASE64" | base64 --decode > cert.p12

          security create-keychain -p "$KEYCHAIN_PASSWORD" ios-build.keychain
          security set-keychain-settings -lut 21600 ios-build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ios-build.keychain

          security import cert.p12 \
            -k ios-build.keychain \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign

          security list-keychains -d user -s ios-build.keychain
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" ios-build.keychain

          security default-keychain -s ios-build.keychain

          security find-identity -v -p codesigning

      # 5Ô∏è‚É£ Install Provisioning Profile (CORRECT PATH)
      - name: Install Provisioning Profile
        env:
          PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          echo "$PROFILE_BASE64" | base64 --decode > profile.mobileprovision
          UUID=$(security cms -D -i profile.mobileprovision | plutil -extract UUID raw -)

          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

          cp profile.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/"$UUID.mobileprovision"

          echo "Installed profile UUID: $UUID"

     # 7Ô∏è‚É£ Build IPA
      - name: Build IPA
        run: |
          # ExportOptions.plist must have the real profile UUID (set in previous step)
          sed -i '' "s/PROFILE_UUID_PLACEHOLDER/$PROFILE_UUID/" ios/ExportOptions.plist
          flutter pub get
          flutter build ipa \
            --release \
            --export-options-plist=ios/ExportOptions.plist
          IPA_PATH=$(find build/ios/ipa -maxdepth 1 -name "*.ipa" 2>/dev/null | head -1)
          if [ -z "$IPA_PATH" ]; then
            IPA_PATH=$(find build/ios -name "*.ipa" 2>/dev/null | head -1)
          fi
          if [ -z "$IPA_PATH" ]; then
            echo "::error::IPA was not produced. Check export/signing (ExportOptions.plist, profile UUID, certificates)."
            ls -la build/ios 2>/dev/null || true
            ls -la build/ios/archive 2>/dev/null || true
            exit 1
          fi
          echo "IPA built: $IPA_PATH"

      # 8Ô∏è‚É£ Upload to TestFlight
      # APPSTORE_API_PRIVATE_KEY must be the base64-encoded contents of your .p8 file
      # (e.g. base64 -i AuthKey_XXXXX.p8 | pbcopy on macOS)
      - name: Upload to TestFlight
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
        run: |
          mkdir -p private_keys
          echo "$APPSTORE_API_PRIVATE_KEY" | base64 --decode > private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8
          chmod 600 private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8

          IPA_PATH=$(find build/ios/ipa -maxdepth 1 -name "*.ipa" 2>/dev/null | head -1)
          if [ -z "$IPA_PATH" ]; then
            IPA_PATH=$(find build/ios -name "*.ipa" 2>/dev/null | head -1)
          fi
          if [ -z "$IPA_PATH" ]; then
            IPA_PATH=$(find . -maxdepth 5 -name "*.ipa" 2>/dev/null | head -1)
          fi
          if [ -z "$IPA_PATH" ]; then
            echo "::error::No IPA found. Expected build/ios/ipa/*.ipa - check that 'Build IPA' step completed successfully."
            ls -la build/ios 2>/dev/null || true
            exit 1
          fi

          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APPSTORE_API_KEY_ID" \
            --apiIssuer "$APPSTORE_ISSUER_ID"


  notify-discord:
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    steps:
      - name: Notify Discord - build success
        if: ${{ needs.build-android.result == 'success' && needs.build-ios.result == 'success' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-${GITHUB_REF}}}"
            ARTIFACTS_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/artifacts"
            payload=$(
              jq -n \
                --arg title "‚úÖ Build succeeded (AAB + IPA)" \
                --arg app "Promise Circles" \
                --arg branch "$BRANCH_NAME" \
                --arg run "${GITHUB_RUN_NUMBER}" \
                --arg status "Success" \
                --arg artifacts "$ARTIFACTS_URL" \
                --arg workflow "$GITHUB_WORKFLOW" \
                --arg repo "$GITHUB_REPOSITORY" \
                --argjson color 3066993 \
                '{
                  embeds: [
                    {
                      title: $title,
                      color: $color,
                      fields: [
                        { "name": "App",       "value": $app,       "inline": true },
                        { "name": "Branch",    "value": $branch,    "inline": true },
                        { "name": "Run",       "value": $run,       "inline": true },
                        { "name": "Status",    "value": $status,    "inline": true },
                        { "name": "Artifacts", "value": ("AAB + IPA: " + $artifacts), "inline": false }
                      ],
                      footer: { "text": ("Workflow: " + $workflow + " ‚Ä¢ Repo: " + $repo) }
                    }
                  ]
                }'
            )
            curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi

      - name: Notify Discord - build failed
        if: ${{ needs.build-android.result == 'failure' || needs.build-ios.result == 'failure' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-${GITHUB_REF}}}"
            LOGS_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            ANDROID_STATUS="${{ needs.build-android.result }}"
            IOS_STATUS="${{ needs.build-ios.result }}"
            FAILED_BUILDS=""
            if [ "$ANDROID_STATUS" = "failure" ]; then
              FAILED_BUILDS="Android AAB"
            fi
            if [ "$IOS_STATUS" = "failure" ]; then
              if [ -n "$FAILED_BUILDS" ]; then
                FAILED_BUILDS="$FAILED_BUILDS + iOS IPA"
              else
                FAILED_BUILDS="iOS IPA"
              fi
            fi
            payload=$(
              jq -n \
                --arg title "‚ùå Build failed" \
                --arg app "Promise Circles" \
                --arg branch "$BRANCH_NAME" \
                --arg run "${GITHUB_RUN_NUMBER}" \
                --arg status "Failed" \
                --arg logs "$LOGS_URL" \
                --arg failed "$FAILED_BUILDS" \
                --arg workflow "$GITHUB_WORKFLOW" \
                --arg repo "$GITHUB_REPOSITORY" \
                --argjson color 15158332 \
                '{
                  embeds: [
                    {
                      title: $title,
                      color: $color,
                      fields: [
                        { "name": "App",        "value": $app,    "inline": true },
                        { "name": "Branch",     "value": $branch, "inline": true },
                        { "name": "Run",        "value": $run,    "inline": true },
                        { "name": "Status",     "value": $status, "inline": true },
                        { "name": "Failed",     "value": $failed, "inline": false },
                        { "name": "Details",    "value": $logs,   "inline": false }
                      ],
                      footer: { "text": ("Workflow: " + $workflow + " ‚Ä¢ Repo: " + $repo) }
                    }
                  ]
                }'
            )
            curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
          fi
